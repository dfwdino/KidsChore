@page "/completions"
@attribute [Authorize(Roles = "Parent")]
@inject IChoreCompletionService ChoreCompletionService
@inject IKidService KidService
@inject IChoreItemService ChoreItemService
@inject ILocationService LocationService

<h3>Chore Completions</h3>

<button class="btn btn-primary mb-3" @onclick="ToggleForm">@(showForm ? (kidModelIsEdit ? "Edit Completion" : "Hide Form") : "Add Completion")</button>

<div class="collapse @(showForm ? "show" : "")" id="completionForm">
    <EditForm Model="completionModel" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="mb-3">
            <label class="form-label">Kid</label>
            <InputSelect class="form-control" @bind-Value="completionModel.KidId">
                <option value="">Select Kid</option>
                @foreach (var kid in kids)
                {
                    <option value="@kid.KidId">@kid.Name</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label class="form-label">Chore Item</label>
            <InputSelect class="form-control" @bind-Value="completionModel.ChoreItemId" @onchange="OnChoreChanged">
                <option value="">Select Chore</option>
                @foreach (var chore in chores)
                {
                    <option value="@chore.ChoreItemId">@chore.ChoreName</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label class="form-label">Location</label>
            <InputSelect class="form-control" @bind-Value="completionModel.LocationId">
                <option value="">Select Location</option>
                @foreach (var location in locations)
                {
                    <option value="@location.LocationId">@location.LocationName</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <label class="form-label">Price</label>
            <InputNumber class="form-control" @bind-Value="completionModel.Price" />
        </div>
        <div class="mb-3">
            <label class="form-label">Completion Date/Time</label>
            <InputDate class="form-control" @bind-Value="completionModel.CompletionDateTime" />
        </div>
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <InputText class="form-control" @bind-Value="completionModel.Notes" />
        </div>
        <button type="submit" class="btn btn-success">@(completionModel.ChoreCompletionId == 0 ? "Add Completion" : "Update Completion")</button>
        @if (completionModel.ChoreCompletionId != 0)
        {
            <button type="button" class="btn btn-secondary ms-2" @onclick="ClearForm">Cancel</button>
        }
    </EditForm>
</div>

<div class="d-none d-md-block">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Kid</th>
                <th>Chore</th>
                <th>Location</th>
                <th>Date</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var completion in completions)
            {
                <tr>
                    <td>@kids.FirstOrDefault(k => k.KidId == completion.KidId)?.Name</td>
                    <td>@chores.FirstOrDefault(c => c.ChoreItemId == completion.ChoreItemId)?.ChoreName</td>
                    <td>@locations.FirstOrDefault(l => l.LocationId == completion.LocationId)?.LocationName</td>
                    <td>@completion.CompletionDateTime.ToShortDateString()</td>
                    <td>@completion.Notes</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" @onclick="() => EditCompletion(completion)">Edit</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteCompletion(completion.ChoreCompletionId)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<div class="d-block d-md-none">
    @foreach (var completion in completions)
    {
        <div class="card mb-2 shadow-sm">
            <div class="card-body p-2">
                <div><strong>Kid:</strong> @kids.FirstOrDefault(k => k.KidId == completion.KidId)?.Name</div>
                <div><strong>Chore:</strong> @chores.FirstOrDefault(c => c.ChoreItemId == completion.ChoreItemId)?.ChoreName</div>
                <div><strong>Location:</strong> @locations.FirstOrDefault(l => l.LocationId == completion.LocationId)?.LocationName</div>
                <div><strong>Date:</strong> @completion.CompletionDateTime.ToShortDateString()</div>
                @if (!string.IsNullOrWhiteSpace(completion.Notes))
                {
                    <div><strong>Notes:</strong> @completion.Notes</div>
                }
                <div class="mt-2 d-flex gap-2">
                    <button class="btn btn-info flex-fill" @onclick="() => EditCompletion(completion)">Edit</button>
                    <button class="btn btn-danger flex-fill" @onclick="() => DeleteCompletion(completion.ChoreCompletionId)">Delete</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ChoreCompletion> completions = new();
    private ChoreCompletion completionModel = new() { CompletionDateTime = DateTime.Now };
    private List<Kid> kids = new();
    private List<ChoreItem> chores = new();
    private List<Location> locations = new();
    private bool showForm = false;
    private bool kidModelIsEdit => completionModel.ChoreCompletionId != 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        completions = (await ChoreCompletionService.GetAllAsync())
            .Where(c => !c.IsDeleted)
            .OrderByDescending(c => c.CompletionDateTime)
            .ThenBy(c => c.ChoreCompletionId)
            .ToList();
        kids = (await KidService.GetAllAsync()).Where(k => !k.IsDeleted).ToList();
        chores = (await ChoreItemService.GetAllAsync()).Where(c => !c.IsDeleted).ToList();
        locations = (await LocationService.GetAllAsync()).Where(l => !l.IsDeleted).ToList();
        // Set default location if not editing
        if (completionModel.ChoreCompletionId == 0)
        {
            var defaultLoc = locations.FirstOrDefault(l => l.LocationName.Equals("Daddy's Home", StringComparison.OrdinalIgnoreCase));
            if (defaultLoc != null)
                completionModel.LocationId = defaultLoc.LocationId;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (completionModel.ChoreCompletionId == 0)
            await ChoreCompletionService.AddAsync(completionModel);
        else
            await ChoreCompletionService.UpdateAsync(completionModel);
        await LoadData();
        ClearForm();
    }

    private void EditCompletion(ChoreCompletion completion)
    {
        completionModel = new ChoreCompletion
        {
            ChoreCompletionId = completion.ChoreCompletionId,
            KidId = completion.KidId,
            ChoreItemId = completion.ChoreItemId,
            LocationId = completion.LocationId,
            CompletionDateTime = completion.CompletionDateTime,
            Notes = completion.Notes
        };
        showForm = true;
    }

    private async Task DeleteCompletion(int id)
    {
        await ChoreCompletionService.DeleteAsync(id);
        await LoadData();
    }

    private void ClearForm()
    {
        completionModel = new ChoreCompletion { CompletionDateTime = DateTime.Now };
        // Set default location
        var defaultLoc = locations.FirstOrDefault(l => l.LocationName.Equals("Daddy's Home", StringComparison.OrdinalIgnoreCase));
        if (defaultLoc != null)
            completionModel.LocationId = defaultLoc.LocationId;
        showForm = false;
    }

    private void ToggleForm()
    {
        showForm = !showForm;
    }

    private void OnChoreChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int choreId))
        {
            var selectedChore = chores.FirstOrDefault(c => c.ChoreItemId == choreId);
            if (selectedChore != null && completionModel.ChoreCompletionId == 0)
            {
                completionModel.Price = selectedChore.Price;
            }
        }
    }
} 